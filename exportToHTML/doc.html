<html>
<head>
<title>Wechat.php</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.ln { color: rgb(0,0,0); font-weight: normal; font-style: normal; }
.s0 { color: rgb(255,255,255); font-weight: bold; }
.s1 { color: rgb(255,255,255); }
.s2 { color: rgb(92,92,91); font-style: italic; }
.s3 { color: rgb(92,92,91); font-weight: bold; font-style: italic; }
.s4 { color: rgb(204,51,51); }
.s5 { color: rgb(255,204,51); }
.s6 { color: rgb(51,153,204); }
.s7 { color: rgb(153,204,51); }
.s8 { color: rgb(155,112,63); }
.s9 { color: rgb(153,255,0); }
body *{font-family: Consolas, "Microsoft Yahei", arial, sans-serif}
</style>
</head>
<BODY BGCOLOR="#232323">
<TABLE CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#C0C0C0" >
<TR><TD><CENTER>
<FONT COLOR="#000000">
Wechat.php</FONT>
</center></TD></TR></TABLE>
<pre>

<span class="s0">&lt;?php</span><span class="s1"> 
</span><span class="s2">/** 
 * </span><span class="s3">@project </span><span class="s2">wechatPublicPlatform 
 * </span><span class="s3">@date </span><span class="s2">2015-4-3 
 * </span><span class="s3">@author </span><span class="s2">xialei &lt;</span><span class="s3">xialeistudio@gmail.com</span><span class="s2">&gt;
 * </span><span class="s3">@link http://www.ddhigh.com</span><span class="s2"> 
 */</span><span class="s1"> 
 
</span><span class="s2">/** 
 * 使用本程序最低PHP版本为5.4 
 * 如果想在低版本PHP使用，请更改以下选项 
 * 更改数组形式为array 
 * 更改json_encode的第二个参数，请使用其他方式实现JSON编码不转成UTF-8 
 * 
 * 微信公众平台开发 
 * Class Wechat 
 * </span><span class="s3">@link http://mp.weixin.qq.com/wiki/home/index.html</span><span class="s2"> 
 */</span><span class="s1"> 
</span><span class="s4">class </span><span class="s5">Wechat</span><span class="s1"> 
{ 
    </span><span class="s2">/** 
     * </span><span class="s3">@var </span><span class="s2">string 微信公众号APPID 
     */</span><span class="s1"> 
    </span><span class="s4">private </span><span class="s6">$appId</span><span class="s1">; 
    </span><span class="s2">/** 
     * </span><span class="s3">@var </span><span class="s2">string 微信公众号APPKEY 
     */</span><span class="s1"> 
    </span><span class="s4">private </span><span class="s6">$appKey</span><span class="s1">; 
 
    </span><span class="s2">/** 
     * </span><span class="s3">@var </span><span class="s2">string 通信TOKEN 
     */</span><span class="s1"> 
    </span><span class="s4">private </span><span class="s6">$token</span><span class="s1">; 
    </span><span class="s2">/** 
     * </span><span class="s3">@var </span><span class="s2">string 请求微信接口必须参数 
     */</span><span class="s1"> 
    </span><span class="s4">private </span><span class="s6">$access_token</span><span class="s1">; 
 
    </span><span class="s2">/** 
     * </span><span class="s3">@var </span><span class="s2">array 微信公众平台交互数据 
     */</span><span class="s1"> 
    </span><span class="s4">private </span><span class="s6">$pushData</span><span class="s1">; 
 
    </span><span class="s2">/** 
     * 实例化 
     * </span><span class="s3">@param </span><span class="s2">string $appId AppID 
     * </span><span class="s3">@param </span><span class="s2">string $appKey AppKey 
     * </span><span class="s3">@param </span><span class="s2">string $token 通信密钥 
     * </span><span class="s3">@param </span><span class="s2">string $accessToken AccessToken 
     * </span><span class="s3">@throws </span><span class="s2">Exception 消息签名失败 
     */</span><span class="s1"> 
    </span><span class="s4">function </span><span class="s5">__construct</span><span class="s1">(</span><span class="s6">$appId</span><span class="s1">, </span><span class="s6">$appKey</span><span class="s1">, </span><span class="s6">$token</span><span class="s1">, </span><span class="s6">$accessToken </span><span class="s1">= </span><span class="s7">''</span><span class="s1">)
    { 
        </span><span class="s6">$this</span><span class="s1">-&gt;</span><span class="s5">appId </span><span class="s1">= </span><span class="s6">$appId</span><span class="s1">;
        </span><span class="s6">$this</span><span class="s1">-&gt;</span><span class="s5">appKey </span><span class="s1">= </span><span class="s6">$appKey</span><span class="s1">;
        </span><span class="s6">$this</span><span class="s1">-&gt;</span><span class="s5">token </span><span class="s1">= </span><span class="s6">$token</span><span class="s1">;
        </span><span class="s6">$this</span><span class="s1">-&gt;</span><span class="s5">checkSign</span><span class="s1">();
        </span><span class="s4">if </span><span class="s1">(!</span><span class="s4">empty</span><span class="s1">(</span><span class="s6">$accessToken</span><span class="s1">)) {
            </span><span class="s6">$this</span><span class="s1">-&gt;</span><span class="s5">access_token </span><span class="s1">= </span><span class="s6">$accessToken</span><span class="s1">;
        } </span><span class="s4">else </span><span class="s1">{ 
            </span><span class="s6">$this</span><span class="s1">-&gt;</span><span class="s5">getAccessTokenFromRemote</span><span class="s1">();
        } 
    } 
 
    </span><span class="s2">/** 
     * 获取AppID 
     * </span><span class="s3">@return </span><span class="s2">string 
     */</span><span class="s1"> 
    </span><span class="s4">public function </span><span class="s5">getAppId</span><span class="s1">() 
    { 
        </span><span class="s4">return </span><span class="s6">$this</span><span class="s1">-&gt;</span><span class="s5">appId</span><span class="s1">;
    } 
 
    </span><span class="s2">/** 
     * 获取AppKey 
     * </span><span class="s3">@return </span><span class="s2">string 
     */</span><span class="s1"> 
    </span><span class="s4">public function </span><span class="s5">getAppKey</span><span class="s1">() 
    { 
        </span><span class="s4">return </span><span class="s6">$this</span><span class="s1">-&gt;</span><span class="s5">appKey</span><span class="s1">;
    } 
 
    </span><span class="s2">/** 
     * 获取AccessToken 
     * </span><span class="s3">@return </span><span class="s2">string 
     */</span><span class="s1"> 
    </span><span class="s4">public function </span><span class="s5">getAccessToken</span><span class="s1">() 
    { 
        </span><span class="s4">return </span><span class="s6">$this</span><span class="s1">-&gt;</span><span class="s5">access_token</span><span class="s1">;
    } 
 
    </span><span class="s2">/** 
     * 设置AccessToken 
     * </span><span class="s3">@param </span><span class="s2">string $access_token AccessToken 
     */</span><span class="s1"> 
    </span><span class="s4">public function </span><span class="s5">setAccessToken</span><span class="s1">(</span><span class="s6">$access_token</span><span class="s1">)
    { 
        </span><span class="s6">$this</span><span class="s1">-&gt;</span><span class="s5">access_token </span><span class="s1">= </span><span class="s6">$access_token</span><span class="s1">;
    } 
 
    </span><span class="s2">/** 
     * 执行POST请求 
     * </span><span class="s3">@param </span><span class="s2">string $url 请求地址 
     * </span><span class="s3">@param </span><span class="s2">array $params GET参数，会拼接到URL中 
     * </span><span class="s3">@param </span><span class="s2">array $data POST参数 
     * </span><span class="s3">@param </span><span class="s2">bool $return 是否返回执行结果 
     * </span><span class="s3">@return </span><span class="s2">array|null 
     * </span><span class="s3">@throws </span><span class="s2">Exception 请求出错 
     */</span><span class="s1"> 
    </span><span class="s4">private function </span><span class="s5">post</span><span class="s1">(</span><span class="s6">$url</span><span class="s1">, </span><span class="s6">$params </span><span class="s1">= [], </span><span class="s6">$data </span><span class="s1">= [], </span><span class="s6">$return </span><span class="s1">= </span><span class="s5">true</span><span class="s1">)
    { 
        </span><span class="s6">$ch </span><span class="s1">= </span><span class="s8">curl_init</span><span class="s1">(); 
        </span><span class="s2">//GET参数处理</span><span class="s1"> 
        </span><span class="s6">$GetParams </span><span class="s1">= </span><span class="s8">urldecode</span><span class="s1">(</span><span class="s8">http_build_query</span><span class="s1">(</span><span class="s6">$params</span><span class="s1">));
        </span><span class="s2">//URL处理</span><span class="s1"> 
        </span><span class="s4">if </span><span class="s1">(</span><span class="s8">strpos</span><span class="s1">(</span><span class="s6">$url</span><span class="s1">, </span><span class="s7">'?'</span><span class="s1">)) {
            </span><span class="s6">$url </span><span class="s1">.= </span><span class="s7">'&amp;' </span><span class="s1">. </span><span class="s6">$GetParams</span><span class="s1">;
        } </span><span class="s4">else </span><span class="s1">{ 
            </span><span class="s6">$url </span><span class="s1">.= </span><span class="s7">'?' </span><span class="s1">. </span><span class="s6">$GetParams</span><span class="s1">;
        } 
        </span><span class="s6">$data </span><span class="s1">= </span><span class="s8">is_array</span><span class="s1">(</span><span class="s6">$data</span><span class="s1">) ? </span><span class="s5">json_encode</span><span class="s1">(</span><span class="s6">$data</span><span class="s1">, </span><span class="s5">JSON_UNESCAPED_UNICODE</span><span class="s1">) : </span><span class="s6">$data</span><span class="s1">;
        </span><span class="s2">//通用参数设置</span><span class="s1"> 
        </span><span class="s8">curl_setopt</span><span class="s1">(</span><span class="s6">$ch</span><span class="s1">, </span><span class="s5">CURLOPT_URL</span><span class="s1">, </span><span class="s6">$url</span><span class="s1">);
        </span><span class="s8">curl_setopt</span><span class="s1">(</span><span class="s6">$ch</span><span class="s1">, </span><span class="s5">CURLOPT_POST</span><span class="s1">, </span><span class="s9">1</span><span class="s1">);
        </span><span class="s8">curl_setopt</span><span class="s1">(</span><span class="s6">$ch</span><span class="s1">, </span><span class="s5">CURLOPT_POSTFIELDS</span><span class="s1">, </span><span class="s6">$data</span><span class="s1">);
        </span><span class="s4">if </span><span class="s1">(</span><span class="s6">$return</span><span class="s1">) { 
            </span><span class="s8">curl_setopt</span><span class="s1">(</span><span class="s6">$ch</span><span class="s1">, </span><span class="s5">CURLOPT_RETURNTRANSFER</span><span class="s1">, </span><span class="s9">1</span><span class="s1">);
        } 
        </span><span class="s2">//关闭SSL验证</span><span class="s1"> 
        </span><span class="s8">curl_setopt</span><span class="s1">(</span><span class="s6">$ch</span><span class="s1">, </span><span class="s5">CURLOPT_SSL_VERIFYHOST</span><span class="s1">, </span><span class="s9">0</span><span class="s1">);
        </span><span class="s8">curl_setopt</span><span class="s1">(</span><span class="s6">$ch</span><span class="s1">, </span><span class="s5">CURLOPT_SSL_VERIFYPEER</span><span class="s1">, </span><span class="s9">0</span><span class="s1">);
        </span><span class="s4">if </span><span class="s1">(</span><span class="s6">$return</span><span class="s1">) { 
            </span><span class="s6">$resp </span><span class="s1">= </span><span class="s8">curl_exec</span><span class="s1">(</span><span class="s6">$ch</span><span class="s1">);
            </span><span class="s8">curl_close</span><span class="s1">(</span><span class="s6">$ch</span><span class="s1">);
            </span><span class="s6">$json </span><span class="s1">= </span><span class="s5">json_decode</span><span class="s1">(</span><span class="s6">$resp</span><span class="s1">, </span><span class="s5">true</span><span class="s1">);
            </span><span class="s4">if </span><span class="s1">(</span><span class="s4">isset</span><span class="s1">(</span><span class="s6">$json</span><span class="s1">[</span><span class="s7">'errcode'</span><span class="s1">]) &amp;&amp; </span><span class="s6">$json</span><span class="s1">[</span><span class="s7">'errcode'</span><span class="s1">] != </span><span class="s9">0</span><span class="s1">) {
                </span><span class="s4">throw new </span><span class="s5">Exception</span><span class="s1">(</span><span class="s6">$json</span><span class="s1">[</span><span class="s7">'errmsg'</span><span class="s1">], </span><span class="s6">$json</span><span class="s1">[</span><span class="s7">'errcode'</span><span class="s1">]);
            } 
            </span><span class="s4">return </span><span class="s6">$json</span><span class="s1">; 
        } </span><span class="s4">else </span><span class="s1">{ 
            </span><span class="s8">curl_exec</span><span class="s1">(</span><span class="s6">$ch</span><span class="s1">);
            </span><span class="s8">curl_close</span><span class="s1">(</span><span class="s6">$ch</span><span class="s1">);
            </span><span class="s4">return </span><span class="s5">null</span><span class="s1">; 
        } 
    } 
 
    </span><span class="s2">/** 
     * 执行GET请求 
     * </span><span class="s3">@param </span><span class="s2">string $url 请求地址 
     * </span><span class="s3">@param </span><span class="s2">array $params GET参数，会拼接到URL中 
     * </span><span class="s3">@param </span><span class="s2">bool $return 是否返回执行结果 
     * </span><span class="s3">@return </span><span class="s2">mixed|null 
     * </span><span class="s3">@throws </span><span class="s2">Exception 请求出错 
     */</span><span class="s1"> 
    </span><span class="s4">private function </span><span class="s5">get</span><span class="s1">(</span><span class="s6">$url</span><span class="s1">, </span><span class="s6">$params </span><span class="s1">= [], </span><span class="s6">$return </span><span class="s1">= </span><span class="s5">true</span><span class="s1">)
    { 
        </span><span class="s6">$ch </span><span class="s1">= </span><span class="s8">curl_init</span><span class="s1">(); 
        </span><span class="s2">//GET参数处理</span><span class="s1"> 
        </span><span class="s6">$GetParams </span><span class="s1">= </span><span class="s8">urldecode</span><span class="s1">(</span><span class="s8">http_build_query</span><span class="s1">(</span><span class="s6">$params</span><span class="s1">));
        </span><span class="s2">//URL处理</span><span class="s1"> 
        </span><span class="s4">if </span><span class="s1">(</span><span class="s8">strpos</span><span class="s1">(</span><span class="s6">$url</span><span class="s1">, </span><span class="s7">'?'</span><span class="s1">)) {
            </span><span class="s6">$url </span><span class="s1">.= </span><span class="s7">'&amp;' </span><span class="s1">. </span><span class="s6">$GetParams</span><span class="s1">;
        } </span><span class="s4">else </span><span class="s1">{ 
            </span><span class="s6">$url </span><span class="s1">.= </span><span class="s7">'?' </span><span class="s1">. </span><span class="s6">$GetParams</span><span class="s1">;
        } 
        </span><span class="s2">//通用参数设置</span><span class="s1"> 
        </span><span class="s8">curl_setopt</span><span class="s1">(</span><span class="s6">$ch</span><span class="s1">, </span><span class="s5">CURLOPT_URL</span><span class="s1">, </span><span class="s6">$url</span><span class="s1">);
        </span><span class="s4">if </span><span class="s1">(</span><span class="s6">$return</span><span class="s1">) { 
            </span><span class="s8">curl_setopt</span><span class="s1">(</span><span class="s6">$ch</span><span class="s1">, </span><span class="s5">CURLOPT_RETURNTRANSFER</span><span class="s1">, </span><span class="s9">1</span><span class="s1">);
        } 
        </span><span class="s2">//关闭SSL验证</span><span class="s1"> 
        </span><span class="s8">curl_setopt</span><span class="s1">(</span><span class="s6">$ch</span><span class="s1">, </span><span class="s5">CURLOPT_SSL_VERIFYHOST</span><span class="s1">, </span><span class="s9">0</span><span class="s1">);
        </span><span class="s8">curl_setopt</span><span class="s1">(</span><span class="s6">$ch</span><span class="s1">, </span><span class="s5">CURLOPT_SSL_VERIFYPEER</span><span class="s1">, </span><span class="s9">0</span><span class="s1">);
        </span><span class="s4">if </span><span class="s1">(</span><span class="s6">$return</span><span class="s1">) { 
            </span><span class="s6">$resp </span><span class="s1">= </span><span class="s8">curl_exec</span><span class="s1">(</span><span class="s6">$ch</span><span class="s1">);
            </span><span class="s8">curl_close</span><span class="s1">(</span><span class="s6">$ch</span><span class="s1">);
            </span><span class="s6">$json </span><span class="s1">= </span><span class="s5">json_decode</span><span class="s1">(</span><span class="s6">$resp</span><span class="s1">, </span><span class="s5">true</span><span class="s1">);
            </span><span class="s4">if </span><span class="s1">(</span><span class="s4">isset</span><span class="s1">(</span><span class="s6">$json</span><span class="s1">[</span><span class="s7">'errcode'</span><span class="s1">]) &amp;&amp; </span><span class="s6">$json</span><span class="s1">[</span><span class="s7">'errcode'</span><span class="s1">] != </span><span class="s9">0</span><span class="s1">) {
                </span><span class="s4">throw new </span><span class="s5">Exception</span><span class="s1">(</span><span class="s6">$json</span><span class="s1">[</span><span class="s7">'errmsg'</span><span class="s1">], </span><span class="s6">$json</span><span class="s1">[</span><span class="s7">'errcode'</span><span class="s1">]);
            } 
            </span><span class="s4">return </span><span class="s6">$json</span><span class="s1">; 
        } </span><span class="s4">else </span><span class="s1">{ 
            </span><span class="s8">curl_exec</span><span class="s1">(</span><span class="s6">$ch</span><span class="s1">);
            </span><span class="s8">curl_close</span><span class="s1">(</span><span class="s6">$ch</span><span class="s1">);
            </span><span class="s4">return </span><span class="s5">null</span><span class="s1">; 
        } 
    } 
 
    </span><span class="s2">/** 
     * curl上传文件 
     * </span><span class="s3">@param </span><span class="s2">string $url 上传地址 
     * </span><span class="s3">@param </span><span class="s2">string $path 本地文件路径 
     * </span><span class="s3">@param </span><span class="s2">array $params GET 参数 
     * </span><span class="s3">@param </span><span class="s2">string $field 字段名，接收使用$_FILES[$field]接收 
     * </span><span class="s3">@param </span><span class="s2">bool $return 是否返回 
     * </span><span class="s3">@return </span><span class="s2">mixed|null 上传结果 
     * </span><span class="s3">@throws </span><span class="s2">Exception 
     */</span><span class="s1"> 
    </span><span class="s4">private function </span><span class="s5">upload</span><span class="s1">(</span><span class="s6">$url</span><span class="s1">, </span><span class="s6">$path</span><span class="s1">, </span><span class="s6">$params </span><span class="s1">= [], </span><span class="s6">$field </span><span class="s1">= </span><span class="s7">'media'</span><span class="s1">, </span><span class="s6">$return </span><span class="s1">= </span><span class="s5">true</span><span class="s1">)
    { 
        </span><span class="s6">$ch </span><span class="s1">= </span><span class="s8">curl_init</span><span class="s1">(); 
        </span><span class="s2">//GET参数处理</span><span class="s1"> 
        </span><span class="s6">$GetParams </span><span class="s1">= </span><span class="s8">urldecode</span><span class="s1">(</span><span class="s8">http_build_query</span><span class="s1">(</span><span class="s6">$params</span><span class="s1">));
        </span><span class="s2">//URL处理</span><span class="s1"> 
        </span><span class="s4">if </span><span class="s1">(</span><span class="s8">strpos</span><span class="s1">(</span><span class="s6">$url</span><span class="s1">, </span><span class="s7">'?'</span><span class="s1">)) {
            </span><span class="s6">$url </span><span class="s1">.= </span><span class="s7">'&amp;' </span><span class="s1">. </span><span class="s6">$GetParams</span><span class="s1">;
        } </span><span class="s4">else </span><span class="s1">{ 
            </span><span class="s6">$url </span><span class="s1">.= </span><span class="s7">'?' </span><span class="s1">. </span><span class="s6">$GetParams</span><span class="s1">;
        } 
        </span><span class="s2">//通用参数设置</span><span class="s1"> 
        </span><span class="s8">curl_setopt</span><span class="s1">(</span><span class="s6">$ch</span><span class="s1">, </span><span class="s5">CURLOPT_URL</span><span class="s1">, </span><span class="s6">$url</span><span class="s1">);
        </span><span class="s4">if </span><span class="s1">(</span><span class="s6">$return</span><span class="s1">) { 
            </span><span class="s8">curl_setopt</span><span class="s1">(</span><span class="s6">$ch</span><span class="s1">, </span><span class="s5">CURLOPT_RETURNTRANSFER</span><span class="s1">, </span><span class="s9">1</span><span class="s1">);
        } 
        </span><span class="s2">//关闭SSL验证</span><span class="s1"> 
        </span><span class="s8">curl_setopt</span><span class="s1">(</span><span class="s6">$ch</span><span class="s1">, </span><span class="s5">CURLOPT_SSL_VERIFYHOST</span><span class="s1">, </span><span class="s9">0</span><span class="s1">);
        </span><span class="s8">curl_setopt</span><span class="s1">(</span><span class="s6">$ch</span><span class="s1">, </span><span class="s5">CURLOPT_SSL_VERIFYPEER</span><span class="s1">, </span><span class="s9">0</span><span class="s1">);
        </span><span class="s2">//上传兼容处理</span><span class="s1"> 
        </span><span class="s8">curl_setopt</span><span class="s1">(</span><span class="s6">$ch</span><span class="s1">, </span><span class="s5">CURLOPT_POST</span><span class="s1">, </span><span class="s9">1</span><span class="s1">);
        </span><span class="s4">if </span><span class="s1">(</span><span class="s8">class_exists</span><span class="s1">(</span><span class="s7">'\CURLFile'</span><span class="s1">)) {
            </span><span class="s8">curl_setopt</span><span class="s1">(</span><span class="s6">$ch</span><span class="s1">, </span><span class="s5">CURLOPT_SAFE_UPLOAD</span><span class="s1">, </span><span class="s5">true</span><span class="s1">);
            </span><span class="s8">curl_setopt</span><span class="s1">(</span><span class="s6">$ch</span><span class="s1">, </span><span class="s5">CURLOPT_POSTFIELDS</span><span class="s1">, [
                </span><span class="s6">$field </span><span class="s1">=&gt; </span><span class="s4">new </span><span class="s5">CURLFile</span><span class="s1">(</span><span class="s8">realpath</span><span class="s1">(</span><span class="s6">$path</span><span class="s1">)),
            ]); 
        } </span><span class="s4">else </span><span class="s1">{ 
            </span><span class="s4">if </span><span class="s1">(</span><span class="s8">defined</span><span class="s1">(</span><span class="s7">'CURLOPT_SAFE_UPLOAD'</span><span class="s1">)) {
                </span><span class="s8">curl_setopt</span><span class="s1">(</span><span class="s6">$ch</span><span class="s1">, </span><span class="s5">CURLOPT_SAFE_UPLOAD</span><span class="s1">, </span><span class="s5">false</span><span class="s1">);
            } 
            </span><span class="s8">curl_setopt</span><span class="s1">(</span><span class="s6">$ch</span><span class="s1">, </span><span class="s5">CURLOPT_POSTFIELDS</span><span class="s1">, [
                </span><span class="s6">$field </span><span class="s1">=&gt; </span><span class="s7">'@' </span><span class="s1">. </span><span class="s8">realpath</span><span class="s1">(</span><span class="s6">$path</span><span class="s1">)
            ]); 
        } 
        </span><span class="s4">if </span><span class="s1">(</span><span class="s6">$return</span><span class="s1">) { 
            </span><span class="s6">$resp </span><span class="s1">= </span><span class="s8">curl_exec</span><span class="s1">(</span><span class="s6">$ch</span><span class="s1">);
            </span><span class="s8">curl_close</span><span class="s1">(</span><span class="s6">$ch</span><span class="s1">);
            </span><span class="s6">$json </span><span class="s1">= </span><span class="s5">json_decode</span><span class="s1">(</span><span class="s6">$resp</span><span class="s1">, </span><span class="s5">true</span><span class="s1">);
            </span><span class="s4">if </span><span class="s1">(</span><span class="s4">isset</span><span class="s1">(</span><span class="s6">$json</span><span class="s1">[</span><span class="s7">'errcode'</span><span class="s1">]) &amp;&amp; </span><span class="s6">$json</span><span class="s1">[</span><span class="s7">'errcode'</span><span class="s1">] != </span><span class="s9">0</span><span class="s1">) {
                </span><span class="s4">throw new </span><span class="s5">Exception</span><span class="s1">(</span><span class="s6">$json</span><span class="s1">[</span><span class="s7">'errmsg'</span><span class="s1">], </span><span class="s6">$json</span><span class="s1">[</span><span class="s7">'errcode'</span><span class="s1">]);
            } 
            </span><span class="s4">return </span><span class="s6">$json</span><span class="s1">; 
        } </span><span class="s4">else </span><span class="s1">{ 
            </span><span class="s8">curl_exec</span><span class="s1">(</span><span class="s6">$ch</span><span class="s1">);
            </span><span class="s8">curl_close</span><span class="s1">(</span><span class="s6">$ch</span><span class="s1">);
            </span><span class="s4">return </span><span class="s5">null</span><span class="s1">; 
        } 
    } 
 
    </span><span class="s2">/** 
     * 从微信服务器读取AccessToken 
     * </span><span class="s3">@param </span><span class="s2">bool $setToSelf 是否设置到本实例 
     * </span><span class="s3">@return </span><span class="s2">mixed|null 
     * [ 
     *  'access_token'=&gt;'AccessToken',  微信AccessToken 
     *  'expires_in'=&gt;'过期时间'    该AccessToken在多久以后失效，单位（秒） 
     * ] 
     */</span><span class="s1"> 
    </span><span class="s4">public function </span><span class="s5">getAccessTokenFromRemote</span><span class="s1">(</span><span class="s6">$setToSelf </span><span class="s1">= </span><span class="s5">true</span><span class="s1">)
    { 
        </span><span class="s6">$url </span><span class="s1">= </span><span class="s7">'https://api.weixin.qq.com/cgi-bin/token'</span><span class="s1">;
        </span><span class="s6">$params </span><span class="s1">= [ 
            </span><span class="s7">'grant_type' </span><span class="s1">=&gt; </span><span class="s7">'client_credential'</span><span class="s1">,
            </span><span class="s7">'appid' </span><span class="s1">=&gt; </span><span class="s6">$this</span><span class="s1">-&gt;</span><span class="s5">appId</span><span class="s1">,
            </span><span class="s7">'secret' </span><span class="s1">=&gt; </span><span class="s6">$this</span><span class="s1">-&gt;</span><span class="s5">appKey</span><span class="s1">
        ]; 
        </span><span class="s6">$data </span><span class="s1">= </span><span class="s6">$this</span><span class="s1">-&gt;</span><span class="s5">get</span><span class="s1">(</span><span class="s6">$url</span><span class="s1">, </span><span class="s6">$params</span><span class="s1">);
        </span><span class="s4">if </span><span class="s1">(</span><span class="s6">$setToSelf</span><span class="s1">) { 
            </span><span class="s6">$this</span><span class="s1">-&gt;</span><span class="s5">setAccessToken</span><span class="s1">(</span><span class="s6">$data</span><span class="s1">[</span><span class="s7">'access_token'</span><span class="s1">]);
        } 
        </span><span class="s4">return </span><span class="s6">$data</span><span class="s1">; 
    } 
 
    </span><span class="s2">/** 
     * 获取微信服务器IP地址 
     * </span><span class="s3">@return </span><span class="s2">array ip列表 ['127.0.0.1','127.0.0.1'] 
     * </span><span class="s3">@throws </span><span class="s2">Exception 
     */</span><span class="s1"> 
    </span><span class="s4">public function </span><span class="s5">getWechatServerAddress</span><span class="s1">() 
    { 
        </span><span class="s6">$url </span><span class="s1">= </span><span class="s7">'https://api.weixin.qq.com/cgi-bin/getcallbackip'</span><span class="s1">;
        </span><span class="s6">$params </span><span class="s1">= [ 
            </span><span class="s7">'access_token' </span><span class="s1">=&gt; </span><span class="s6">$this</span><span class="s1">-&gt;</span><span class="s5">getAccessToken</span><span class="s1">()
        ]; 
        </span><span class="s6">$data </span><span class="s1">= </span><span class="s6">$this</span><span class="s1">-&gt;</span><span class="s5">get</span><span class="s1">(</span><span class="s6">$url</span><span class="s1">, </span><span class="s6">$params</span><span class="s1">);
        </span><span class="s4">return </span><span class="s6">$data</span><span class="s1">[</span><span class="s7">'ip_list'</span><span class="s1">];
    } 
 
    </span><span class="s2">/** 
     * 检测消息签名 
     * </span><span class="s3">@throws </span><span class="s2">Exception 
     */</span><span class="s1"> 
    </span><span class="s4">private function </span><span class="s5">checkSign</span><span class="s1">() 
    { 
        </span><span class="s2">//如果是首次接入，直接通过</span><span class="s1"> 
        </span><span class="s4">if </span><span class="s1">(</span><span class="s4">isset</span><span class="s1">(</span><span class="s6">$_GET</span><span class="s1">[</span><span class="s7">'echostr'</span><span class="s1">])) {
            </span><span class="s4">echo </span><span class="s6">$_GET</span><span class="s1">[</span><span class="s7">'echostr'</span><span class="s1">];
            </span><span class="s4">exit</span><span class="s1">; 
        } 
        </span><span class="s2">//参数检测</span><span class="s1"> 
        </span><span class="s4">if </span><span class="s1">(!</span><span class="s4">isset</span><span class="s1">(</span><span class="s6">$_GET</span><span class="s1">[</span><span class="s7">'signature'</span><span class="s1">])) {
            </span><span class="s4">throw new </span><span class="s5">Exception</span><span class="s1">(</span><span class="s7">'缺少签名参数'</span><span class="s1">);
        } 
        </span><span class="s4">if </span><span class="s1">(!</span><span class="s4">isset</span><span class="s1">(</span><span class="s6">$_GET</span><span class="s1">[</span><span class="s7">'timestamp'</span><span class="s1">])) {
            </span><span class="s4">throw new </span><span class="s5">Exception</span><span class="s1">(</span><span class="s7">'缺少时间戳'</span><span class="s1">);
        } 
        </span><span class="s4">if </span><span class="s1">(!</span><span class="s4">isset</span><span class="s1">(</span><span class="s6">$_GET</span><span class="s1">[</span><span class="s7">'nonce'</span><span class="s1">])) {
            </span><span class="s4">throw new </span><span class="s5">Exception</span><span class="s1">(</span><span class="s7">'缺少随机数'</span><span class="s1">);
        } 
        </span><span class="s2">//签名验证</span><span class="s1"> 
        </span><span class="s6">$params </span><span class="s1">= [ 
            </span><span class="s6">$this</span><span class="s1">-&gt;</span><span class="s5">token</span><span class="s1">,
            </span><span class="s6">$_GET</span><span class="s1">[</span><span class="s7">'timestamp'</span><span class="s1">],
            </span><span class="s6">$_GET</span><span class="s1">[</span><span class="s7">'nonce'</span><span class="s1">]
        ]; 
        </span><span class="s8">sort</span><span class="s1">(</span><span class="s6">$params</span><span class="s1">, </span><span class="s5">SORT_STRING</span><span class="s1">);
        </span><span class="s6">$str </span><span class="s1">= </span><span class="s8">implode</span><span class="s1">(</span><span class="s6">$params</span><span class="s1">);
        </span><span class="s6">$str </span><span class="s1">= </span><span class="s8">sha1</span><span class="s1">(</span><span class="s6">$str</span><span class="s1">);
        </span><span class="s4">if </span><span class="s1">(</span><span class="s6">$str </span><span class="s1">!= </span><span class="s6">$_GET</span><span class="s1">[</span><span class="s7">'signature'</span><span class="s1">]) {
            </span><span class="s4">throw new </span><span class="s5">Exception</span><span class="s1">(</span><span class="s7">'消息签名失败'</span><span class="s1">);
        } 
    } 
 
    </span><span class="s2">/** 
     * 获取微信推送的数据 
     * </span><span class="s3">@return </span><span class="s2">array 
     */</span><span class="s1"> 
    </span><span class="s4">public function </span><span class="s5">requestWechatPush</span><span class="s1">() 
    { 
        </span><span class="s6">$raw </span><span class="s1">= </span><span class="s8">file_get_contents</span><span class="s1">(</span><span class="s7">'php://input'</span><span class="s1">);
        </span><span class="s6">$xml </span><span class="s1">= </span><span class="s4">new </span><span class="s5">SimpleXMLElement</span><span class="s1">(</span><span class="s6">$raw</span><span class="s1">);
        </span><span class="s4">foreach </span><span class="s1">(</span><span class="s6">$xml </span><span class="s4">as </span><span class="s6">$key </span><span class="s1">=&gt; </span><span class="s6">$value</span><span class="s1">) {
            </span><span class="s6">$this</span><span class="s1">-&gt;</span><span class="s5">pushData</span><span class="s1">[</span><span class="s6">$key</span><span class="s1">] = </span><span class="s6">$value</span><span class="s1">;
        } 
        </span><span class="s4">return </span><span class="s6">$this</span><span class="s1">-&gt;</span><span class="s5">pushData</span><span class="s1">;
    } 
 
    </span><span class="s2">/** 
     * * 响应微信发送的信息（自动回复） 
     * </span><span class="s3">@param  </span><span class="s2">array $content 回复信息，文本信息为string类型 
     * </span><span class="s3">@param  </span><span class="s2">string $type 消息类型 
     * </span><span class="s3">@param </span><span class="s2">int|string $flag 是否新标刚接受到的信息 
     * </span><span class="s3">@return </span><span class="s2">string XML字符串 
     */</span><span class="s1"> 
    </span><span class="s4">public function </span><span class="s5">response</span><span class="s1">(</span><span class="s6">$content</span><span class="s1">, </span><span class="s6">$type </span><span class="s1">= </span><span class="s7">'text'</span><span class="s1">, </span><span class="s6">$flag </span><span class="s1">= </span><span class="s9">0</span><span class="s1">)
    { 
        </span><span class="s2">/* 基础数据 */</span><span class="s1"> 
        </span><span class="s6">$this</span><span class="s1">-&gt;</span><span class="s5">pushData </span><span class="s1">= </span><span class="s4">array</span><span class="s1">(
            </span><span class="s7">'ToUserName' </span><span class="s1">=&gt; </span><span class="s6">$this</span><span class="s1">-&gt;</span><span class="s5">pushData</span><span class="s1">[</span><span class="s7">'FromUserName'</span><span class="s1">],
            </span><span class="s7">'FromUserName' </span><span class="s1">=&gt; </span><span class="s6">$this</span><span class="s1">-&gt;</span><span class="s5">pushData</span><span class="s1">[</span><span class="s7">'ToUserName'</span><span class="s1">],
            </span><span class="s7">'CreateTime' </span><span class="s1">=&gt; </span><span class="s8">time</span><span class="s1">(),
            </span><span class="s7">'MsgType' </span><span class="s1">=&gt; </span><span class="s6">$type</span><span class="s1">,
        ); 
        </span><span class="s2">/* 添加类型数据 */</span><span class="s1"> 
        </span><span class="s4">if </span><span class="s1">(</span><span class="s6">$type </span><span class="s1">!= </span><span class="s7">'transfer_customer_service'</span><span class="s1">) {
            </span><span class="s6">$this</span><span class="s1">-&gt;</span><span class="s6">$type</span><span class="s1">(</span><span class="s6">$content</span><span class="s1">);
        } 
        </span><span class="s2">/* 添加状态 */</span><span class="s1"> 
        </span><span class="s6">$this</span><span class="s1">-&gt;</span><span class="s5">pushData</span><span class="s1">[</span><span class="s7">'FuncFlag'</span><span class="s1">] = </span><span class="s6">$flag</span><span class="s1">;
        </span><span class="s2">/* 转换数据为XML */</span><span class="s1"> 
        </span><span class="s6">$xml </span><span class="s1">= </span><span class="s4">new </span><span class="s5">SimpleXMLElement</span><span class="s1">(</span><span class="s7">'&lt;xml&gt;&lt;/xml&gt;'</span><span class="s1">);
        </span><span class="s6">$this</span><span class="s1">-&gt;</span><span class="s5">data2xml</span><span class="s1">(</span><span class="s6">$xml</span><span class="s1">, </span><span class="s6">$this</span><span class="s1">-&gt;</span><span class="s5">pushData</span><span class="s1">);
        </span><span class="s4">return </span><span class="s6">$xml</span><span class="s1">-&gt;</span><span class="s5">asXML</span><span class="s1">();
    } 
 
    </span><span class="s2">/** 
     * 回复文本信息 
     * </span><span class="s3">@param  </span><span class="s2">string $content 要回复的信息 
     */</span><span class="s1"> 
    </span><span class="s4">private function </span><span class="s5">text</span><span class="s1">(</span><span class="s6">$content</span><span class="s1">)
    { 
        </span><span class="s6">$this</span><span class="s1">-&gt;</span><span class="s5">pushData</span><span class="s1">[</span><span class="s7">'Content'</span><span class="s1">] = </span><span class="s6">$content</span><span class="s1">;
    } 
 
    </span><span class="s2">/** 
     * 回复音乐信息 
     * </span><span class="s3">@param  </span><span class="s2">string $content 要回复的音乐 
     */</span><span class="s1"> 
    </span><span class="s4">private function </span><span class="s5">music</span><span class="s1">(</span><span class="s6">$music</span><span class="s1">)
    { 
        </span><span class="s4">list</span><span class="s1">( 
            </span><span class="s6">$music</span><span class="s1">[</span><span class="s7">'Title'</span><span class="s1">],
            </span><span class="s6">$music</span><span class="s1">[</span><span class="s7">'Description'</span><span class="s1">],
            </span><span class="s6">$music</span><span class="s1">[</span><span class="s7">'MusicUrl'</span><span class="s1">],
            </span><span class="s6">$music</span><span class="s1">[</span><span class="s7">'HQMusicUrl'</span><span class="s1">]
            ) = </span><span class="s6">$music</span><span class="s1">; 
        </span><span class="s6">$this</span><span class="s1">-&gt;</span><span class="s5">pushData</span><span class="s1">[</span><span class="s7">'Music'</span><span class="s1">] = </span><span class="s6">$music</span><span class="s1">;
    } 
 
    </span><span class="s2">/** 
     * 回复图文信息 
     * </span><span class="s3">@param  </span><span class="s2">array $news 要回复的图文内容 
     */</span><span class="s1"> 
    </span><span class="s4">private function </span><span class="s5">news</span><span class="s1">(</span><span class="s6">$news</span><span class="s1">)
    { 
        </span><span class="s6">$articles </span><span class="s1">= </span><span class="s4">array</span><span class="s1">();
        </span><span class="s4">foreach </span><span class="s1">(</span><span class="s6">$news </span><span class="s4">as </span><span class="s6">$key </span><span class="s1">=&gt; </span><span class="s6">$value</span><span class="s1">) {
            </span><span class="s4">list</span><span class="s1">( 
                </span><span class="s6">$articles</span><span class="s1">[</span><span class="s6">$key</span><span class="s1">][</span><span class="s7">'Title'</span><span class="s1">],
                </span><span class="s6">$articles</span><span class="s1">[</span><span class="s6">$key</span><span class="s1">][</span><span class="s7">'Description'</span><span class="s1">],
                </span><span class="s6">$articles</span><span class="s1">[</span><span class="s6">$key</span><span class="s1">][</span><span class="s7">'PicUrl'</span><span class="s1">],
                </span><span class="s6">$articles</span><span class="s1">[</span><span class="s6">$key</span><span class="s1">][</span><span class="s7">'Url'</span><span class="s1">]
                ) = </span><span class="s6">$value</span><span class="s1">; 
            </span><span class="s4">if </span><span class="s1">(</span><span class="s6">$key </span><span class="s1">&gt;= </span><span class="s9">9</span><span class="s1">) {
                </span><span class="s4">break</span><span class="s1">; 
            } </span><span class="s2">//最多只允许10调新闻</span><span class="s1"> 
        } 
        </span><span class="s6">$this</span><span class="s1">-&gt;</span><span class="s5">pushData</span><span class="s1">[</span><span class="s7">'ArticleCount'</span><span class="s1">] = </span><span class="s8">count</span><span class="s1">(</span><span class="s6">$articles</span><span class="s1">);
        </span><span class="s6">$this</span><span class="s1">-&gt;</span><span class="s5">pushData</span><span class="s1">[</span><span class="s7">'Articles'</span><span class="s1">] = </span><span class="s6">$articles</span><span class="s1">;
    } 
 
    </span><span class="s2">/** 
     * 数据XML编码 
     * </span><span class="s3">@param  </span><span class="s2">object $xml XML对象 
     * </span><span class="s3">@param  </span><span class="s2">mixed $data 数据 
     * </span><span class="s3">@param  </span><span class="s2">string $item 数字索引时的节点名称 
     * </span><span class="s3">@return </span><span class="s2">string 
     */</span><span class="s1"> 
    </span><span class="s4">private function </span><span class="s5">data2xml</span><span class="s1">(</span><span class="s6">$xml</span><span class="s1">, </span><span class="s6">$data</span><span class="s1">, </span><span class="s6">$item </span><span class="s1">= </span><span class="s7">'item'</span><span class="s1">)
    { 
        </span><span class="s4">foreach </span><span class="s1">(</span><span class="s6">$data </span><span class="s4">as </span><span class="s6">$key </span><span class="s1">=&gt; </span><span class="s6">$value</span><span class="s1">) {
            </span><span class="s2">/* 指定默认的数字key */</span><span class="s1"> 
            </span><span class="s8">is_numeric</span><span class="s1">(</span><span class="s6">$key</span><span class="s1">) &amp;&amp; </span><span class="s6">$key </span><span class="s1">= </span><span class="s6">$item</span><span class="s1">;
            </span><span class="s2">/* 添加子元素 */</span><span class="s1"> 
            </span><span class="s4">if </span><span class="s1">(</span><span class="s8">is_array</span><span class="s1">(</span><span class="s6">$value</span><span class="s1">) || </span><span class="s8">is_object</span><span class="s1">(</span><span class="s6">$value</span><span class="s1">)) {
                </span><span class="s6">$child </span><span class="s1">= </span><span class="s6">$xml</span><span class="s1">-&gt;</span><span class="s5">addChild</span><span class="s1">(</span><span class="s6">$key</span><span class="s1">);
                </span><span class="s6">$this</span><span class="s1">-&gt;</span><span class="s5">data2xml</span><span class="s1">(</span><span class="s6">$child</span><span class="s1">, </span><span class="s6">$value</span><span class="s1">, </span><span class="s6">$item</span><span class="s1">);
            } </span><span class="s4">else </span><span class="s1">{ 
                </span><span class="s4">if </span><span class="s1">(</span><span class="s8">is_numeric</span><span class="s1">(</span><span class="s6">$value</span><span class="s1">)) {
                    </span><span class="s6">$child </span><span class="s1">= </span><span class="s6">$xml</span><span class="s1">-&gt;</span><span class="s5">addChild</span><span class="s1">(</span><span class="s6">$key</span><span class="s1">, </span><span class="s6">$value</span><span class="s1">);
                } </span><span class="s4">else </span><span class="s1">{ 
                    </span><span class="s6">$child </span><span class="s1">= </span><span class="s6">$xml</span><span class="s1">-&gt;</span><span class="s5">addChild</span><span class="s1">(</span><span class="s6">$key</span><span class="s1">);
                    </span><span class="s6">$node </span><span class="s1">= </span><span class="s5">dom_import_simplexml</span><span class="s1">(</span><span class="s6">$child</span><span class="s1">);
                    </span><span class="s6">$node</span><span class="s1">-&gt;</span><span class="s5">appendChild</span><span class="s1">(</span><span class="s6">$node</span><span class="s1">-&gt;</span><span class="s5">ownerDocument</span><span class="s1">-&gt;</span><span class="s5">createCDATASection</span><span class="s1">(</span><span class="s6">$value</span><span class="s1">));
                } 
            } 
        } 
    } 
 
 
    </span><span class="s2">/** 
     * 添加客服账号 
     * </span><span class="s3">@param </span><span class="s2">array $data 客服账号数据 
     * [ 
     *  'kf_account'=&gt;'test</span><span class="s3">@wechat</span><span class="s2">',wechat为公众平台账号名称,test为客服账号前缀 
     *  'nickname'=&gt;'客服昵称', 
     *  'password'=&gt;'password' password为32位MD5加密结果 
     * ] 
     * </span><span class="s3">@return </span><span class="s2">bool 添加结果 成功|失败 
     * </span><span class="s3">@throws </span><span class="s2">Exception 
     */</span><span class="s1"> 
    </span><span class="s4">public function </span><span class="s5">addCustomer</span><span class="s1">(</span><span class="s6">$data</span><span class="s1">)
    { 
        </span><span class="s6">$url </span><span class="s1">= </span><span class="s7">'https://api.weixin.qq.com/customservice/kfaccount/add'</span><span class="s1">;
        </span><span class="s6">$params </span><span class="s1">= [ 
            </span><span class="s7">'access_token' </span><span class="s1">=&gt; </span><span class="s6">$this</span><span class="s1">-&gt;</span><span class="s5">getAccessToken</span><span class="s1">()
        ]; 
        </span><span class="s4">return </span><span class="s6">$this</span><span class="s1">-&gt;</span><span class="s5">post</span><span class="s1">(</span><span class="s6">$url</span><span class="s1">, </span><span class="s6">$params</span><span class="s1">, </span><span class="s6">$data</span><span class="s1">);
    } 
 
    </span><span class="s2">/** 
     * 修改客服账号 
     * </span><span class="s3">@param </span><span class="s2">array $data 客服账号数据 
     * [ 
     *  'kf_account'=&gt;'test</span><span class="s3">@wechat</span><span class="s2">',wechat为公众平台账号名称,test为客服账号前缀 
     *  'nickname'=&gt;'客服昵称', 
     *  'password'=&gt;'password' password为32位MD5加密结果 
     * ] 
     * </span><span class="s3">@return </span><span class="s2">bool 修改结果 成功|失败 
     * </span><span class="s3">@throws </span><span class="s2">Exception 
     */</span><span class="s1"> 
    </span><span class="s4">public function </span><span class="s5">updateCustomer</span><span class="s1">(</span><span class="s6">$data</span><span class="s1">)
    { 
        </span><span class="s6">$url </span><span class="s1">= </span><span class="s7">'https://api.weixin.qq.com/customservice/kfaccount/update'</span><span class="s1">;
        </span><span class="s6">$params </span><span class="s1">= [ 
            </span><span class="s7">'access_token' </span><span class="s1">=&gt; </span><span class="s6">$this</span><span class="s1">-&gt;</span><span class="s5">getAccessToken</span><span class="s1">()
        ]; 
        </span><span class="s4">return </span><span class="s6">$this</span><span class="s1">-&gt;</span><span class="s5">post</span><span class="s1">(</span><span class="s6">$url</span><span class="s1">, </span><span class="s6">$params</span><span class="s1">, </span><span class="s6">$data</span><span class="s1">);
    } 
 
    </span><span class="s2">/** 
     * 删除客服账号 
     * </span><span class="s3">@param </span><span class="s2">array $data 客服账号数据 
     * [ 
     *  'kf_account'=&gt;'test</span><span class="s3">@wechat</span><span class="s2">',wechat为公众平台账号名称,test为客服账号前缀 
     *  'nickname'=&gt;'客服昵称', 
     *  'password'=&gt;'password' password为32位MD5加密结果 
     * ] 
     * </span><span class="s3">@return </span><span class="s2">bool 删除结果 成功|失败 
     * </span><span class="s3">@throws </span><span class="s2">Exception 
     */</span><span class="s1"> 
    </span><span class="s4">public function </span><span class="s5">deleteCustomer</span><span class="s1">(</span><span class="s6">$data</span><span class="s1">)
    { 
        </span><span class="s6">$url </span><span class="s1">= </span><span class="s7">'https://api.weixin.qq.com/customservice/kfaccount/del'</span><span class="s1">;
        </span><span class="s6">$params </span><span class="s1">= [ 
            </span><span class="s7">'access_token' </span><span class="s1">=&gt; </span><span class="s6">$this</span><span class="s1">-&gt;</span><span class="s5">getAccessToken</span><span class="s1">()
        ]; 
        </span><span class="s4">return </span><span class="s6">$this</span><span class="s1">-&gt;</span><span class="s5">post</span><span class="s1">(</span><span class="s6">$url</span><span class="s1">, </span><span class="s6">$params</span><span class="s1">, </span><span class="s6">$data</span><span class="s1">);
    } 
 
    </span><span class="s2">/** 
     * 设置客服头像 
     * </span><span class="s3">@param </span><span class="s2">string $account 客服账号 test</span><span class="s3">@wechat</span><span class="s2">
     * </span><span class="s3">@param </span><span class="s2">string $path 图片地址，支持远程图片 
     * </span><span class="s3">@return </span><span class="s2">bool 
     * </span><span class="s3">@throws </span><span class="s2">Exception 
     */</span><span class="s1"> 
    </span><span class="s4">public function </span><span class="s5">setCustomerAvatar</span><span class="s1">(</span><span class="s6">$account</span><span class="s1">, </span><span class="s6">$path</span><span class="s1">)
    { 
        </span><span class="s6">$url </span><span class="s1">= </span><span class="s7">'http://api.weixin.qq.com/customservice/kfaccount/uploadheadimg'</span><span class="s1">;
        </span><span class="s6">$params </span><span class="s1">= [ 
            </span><span class="s7">'access_token' </span><span class="s1">=&gt; </span><span class="s6">$this</span><span class="s1">-&gt;</span><span class="s5">getAccessToken</span><span class="s1">(),
            </span><span class="s7">'kf_account' </span><span class="s1">=&gt; </span><span class="s6">$account</span><span class="s1">
        ]; 
        </span><span class="s2">//处理远程图片</span><span class="s1"> 
        </span><span class="s6">$file_path </span><span class="s1">= </span><span class="s7">''</span><span class="s1">;</span><span class="s2">//文件路径</span><span class="s1">
        </span><span class="s4">if </span><span class="s1">(</span><span class="s8">strpos</span><span class="s1">(</span><span class="s6">$path</span><span class="s1">, </span><span class="s7">'http'</span><span class="s1">) !== </span><span class="s5">false</span><span class="s1">) {
            </span><span class="s6">$local_handler </span><span class="s1">= </span><span class="s8">fopen</span><span class="s1">(</span><span class="s6">$file_path</span><span class="s1">, </span><span class="s7">'wb'</span><span class="s1">);
            </span><span class="s4">if </span><span class="s1">(!</span><span class="s6">$local_handler</span><span class="s1">) {
                </span><span class="s4">throw new </span><span class="s5">Exception</span><span class="s1">(</span><span class="s7">'临时文件创建失败'</span><span class="s1">);
            } 
            </span><span class="s6">$remote_handler </span><span class="s1">= </span><span class="s8">fopen</span><span class="s1">(</span><span class="s6">$path</span><span class="s1">, </span><span class="s7">'rb'</span><span class="s1">);
            </span><span class="s4">while </span><span class="s1">(!</span><span class="s8">feof</span><span class="s1">(</span><span class="s6">$remote_handler</span><span class="s1">)) {
                </span><span class="s2">//8K缓冲区</span><span class="s1"> 
                </span><span class="s8">fwrite</span><span class="s1">(</span><span class="s6">$local_handler</span><span class="s1">, </span><span class="s8">fread</span><span class="s1">(</span><span class="s6">$remote_handler</span><span class="s1">, </span><span class="s9">8192</span><span class="s1">));
            } 
            </span><span class="s2">//关闭句柄</span><span class="s1"> 
            </span><span class="s8">fclose</span><span class="s1">(</span><span class="s6">$local_handler</span><span class="s1">);
            </span><span class="s8">fclose</span><span class="s1">(</span><span class="s6">$remote_handler</span><span class="s1">);
        } </span><span class="s4">else </span><span class="s1">{ 
            </span><span class="s6">$file_path </span><span class="s1">= </span><span class="s6">$path</span><span class="s1">;
        } 
        </span><span class="s2">//准备上传</span><span class="s1"> 
        </span><span class="s6">$resp </span><span class="s1">= </span><span class="s6">$this</span><span class="s1">-&gt;</span><span class="s5">upload</span><span class="s1">(</span><span class="s6">$url</span><span class="s1">, </span><span class="s6">$file_path</span><span class="s1">, </span><span class="s6">$params</span><span class="s1">);
        </span><span class="s2">//删除文件</span><span class="s1"> 
        </span><span class="s4">if </span><span class="s1">(</span><span class="s8">strpos</span><span class="s1">(</span><span class="s6">$path</span><span class="s1">, </span><span class="s7">'http'</span><span class="s1">) !== </span><span class="s5">false</span><span class="s1">) {
            </span><span class="s8">unlink</span><span class="s1">(</span><span class="s6">$file_path</span><span class="s1">);
        } 
        </span><span class="s4">return </span><span class="s6">$resp</span><span class="s1">; 
    } 
 
    </span><span class="s2">/** 
     * 获取客服列表 
     * </span><span class="s3">@return </span><span class="s2">array 
     * [ 
     *      [ 
     *      &quot;kf_account&quot;=&gt;&quot;test1@test&quot;, 
     *       &quot;kf_nick&quot;=&gt;&quot;ntest1&quot;, 
     *       &quot;kf_id&quot;=&gt;&quot;1001&quot; 
     *       kf_headimgurl&quot;=&gt;&quot;</span><span class="s3">http://mmbiz.qpic.cn/mmbiz/4whpV1VZl2iccsvYbHvnphkyGtnvjfUS8Ym0GSaLic0FD3vN0V8PILcibEGb2fPfEOmw/0&quot;&quot;</span><span class="s2">
     *      ] 
     * ] 
     * </span><span class="s3">@throws </span><span class="s2">Exception 
     */</span><span class="s1"> 
    </span><span class="s4">public function </span><span class="s5">getCustomers</span><span class="s1">() 
    { 
        </span><span class="s6">$url </span><span class="s1">= </span><span class="s7">'https://api.weixin.qq.com/cgi-bin/customservice/getkflist'</span><span class="s1">;
        </span><span class="s6">$params </span><span class="s1">= [ 
            </span><span class="s7">'access_token' </span><span class="s1">=&gt; </span><span class="s6">$this</span><span class="s1">-&gt;</span><span class="s5">getAccessToken</span><span class="s1">()
        ]; 
        </span><span class="s6">$data </span><span class="s1">= </span><span class="s6">$this</span><span class="s1">-&gt;</span><span class="s5">get</span><span class="s1">(</span><span class="s6">$url</span><span class="s1">, </span><span class="s6">$params</span><span class="s1">);
        </span><span class="s4">return </span><span class="s6">$data</span><span class="s1">[</span><span class="s7">'kf_list'</span><span class="s1">];
    } 
 
 
    </span><span class="s2">/** 
     * 发送客服消息 
     * </span><span class="s3">@param </span><span class="s2">string $openid 用户ID 
     * </span><span class="s3">@param </span><span class="s2">array|string $sendData 要发送的数据 
     * </span><span class="s3">@param </span><span class="s2">string $type 消息类型 
     * </span><span class="s3">@param </span><span class="s2">string $customer 是否指定客服账号发送 
     * </span><span class="s3">@return </span><span class="s2">array|null 
     * </span><span class="s3">@throws </span><span class="s2">Exception 
     * </span><span class="s3">@link http://mp.weixin.qq.com/wiki/1/70a29afed17f56d537c833f89be979c9.html#.E5.AE.A2.E6.9C.8D.E6.8E.A5.E5.8F.A3-.E5.8F.91.E6.B6.88.E6.81.AF </span><span class="s2">参考文档链接
     */</span><span class="s1"> 
    </span><span class="s4">public function </span><span class="s5">sendCustomerMessage</span><span class="s1">(</span><span class="s6">$openid</span><span class="s1">, </span><span class="s6">$sendData</span><span class="s1">, </span><span class="s6">$type </span><span class="s1">= </span><span class="s7">'text'</span><span class="s1">, </span><span class="s6">$customer </span><span class="s1">= </span><span class="s7">''</span><span class="s1">)
    { 
        </span><span class="s6">$url </span><span class="s1">= </span><span class="s7">'https://api.weixin.qq.com/cgi-bin/message/custom/send'</span><span class="s1">;
        </span><span class="s6">$params </span><span class="s1">= [ 
            </span><span class="s7">'access_token' </span><span class="s1">=&gt; </span><span class="s6">$this</span><span class="s1">-&gt;</span><span class="s5">getAccessToken</span><span class="s1">()
        ]; 
        </span><span class="s6">$data </span><span class="s1">= [ 
            </span><span class="s7">'touser' </span><span class="s1">=&gt; </span><span class="s6">$openid</span><span class="s1">,
            </span><span class="s7">'msgtype' </span><span class="s1">=&gt; </span><span class="s6">$type</span><span class="s1">
        ]; 
        </span><span class="s4">if </span><span class="s1">(!</span><span class="s4">empty</span><span class="s1">(</span><span class="s6">$customer</span><span class="s1">)) {
            </span><span class="s6">$data</span><span class="s1">[</span><span class="s7">'customservice'</span><span class="s1">] = [
                </span><span class="s7">'kf_account' </span><span class="s1">=&gt; </span><span class="s6">$customer</span><span class="s1">
            ]; 
        } 
        </span><span class="s4">switch </span><span class="s1">(</span><span class="s6">$type</span><span class="s1">) { 
            </span><span class="s4">case </span><span class="s7">'text'</span><span class="s1">: 
                </span><span class="s6">$data</span><span class="s1">[</span><span class="s7">'text'</span><span class="s1">] = [
                    </span><span class="s7">'content' </span><span class="s1">=&gt; </span><span class="s6">$sendData</span><span class="s1">
                ]; 
                </span><span class="s4">break</span><span class="s1">; 
            </span><span class="s4">case </span><span class="s7">'image'</span><span class="s1">: 
            </span><span class="s4">case </span><span class="s7">'voice'</span><span class="s1">: 
                </span><span class="s6">$data</span><span class="s1">[</span><span class="s6">$type</span><span class="s1">] = [
                    </span><span class="s7">'media_id' </span><span class="s1">=&gt; </span><span class="s6">$sendData</span><span class="s1">
                ]; 
                </span><span class="s4">break</span><span class="s1">; 
            </span><span class="s4">case </span><span class="s7">'video'</span><span class="s1">: 
            </span><span class="s4">case </span><span class="s7">'music'</span><span class="s1">: 
                </span><span class="s6">$data</span><span class="s1">[</span><span class="s6">$type</span><span class="s1">] = </span><span class="s6">$sendData</span><span class="s1">;
                </span><span class="s4">break</span><span class="s1">; 
            </span><span class="s4">case </span><span class="s7">'news'</span><span class="s1">: 
                </span><span class="s6">$data</span><span class="s1">[</span><span class="s7">'news'</span><span class="s1">] = [
                    </span><span class="s7">'articles' </span><span class="s1">=&gt; </span><span class="s6">$sendData</span><span class="s1">
                ]; 
                </span><span class="s4">break</span><span class="s1">; 
            </span><span class="s4">default</span><span class="s1">: 
                </span><span class="s4">throw new </span><span class="s5">Exception</span><span class="s1">(</span><span class="s7">'消息类型不存在'</span><span class="s1">);
                </span><span class="s4">break</span><span class="s1">; 
        } 
 
        </span><span class="s4">return </span><span class="s6">$this</span><span class="s1">-&gt;</span><span class="s5">post</span><span class="s1">(</span><span class="s6">$url</span><span class="s1">, </span><span class="s6">$params</span><span class="s1">, </span><span class="s6">$data</span><span class="s1">);
    } 
 
    </span><span class="s2">/** 
     * 上传图文素材 
     * </span><span class="s3">@param </span><span class="s2">array $articles 
     * </span><span class="s3">@return </span><span class="s2">array|null 
     * </span><span class="s3">@throws </span><span class="s2">Exception 
     * </span><span class="s3">@link http://mp.weixin.qq.com/wiki/15/5380a4e6f02f2ffdc7981a8ed7a40753.html#.E4.B8.8A.E4.BC.A0.E5.9B.BE.E6.96.87.E6.B6.88.E6.81.AF.E7.B4.A0.E6.9D.90.E3.80.90.E8.AE.A2.E9.98.85.E5.8F.B7.E4.B8.8E.E6.9C.8D.E5.8A.A1.E5.8F.B7.E8.AE.A4.E8.AF.81.E5.90.8E.E5.9D.87.E5.8F.AF.E7.94.A8.E3.80.91</span><span class="s2">
     */</span><span class="s1"> 
    </span><span class="s4">public function </span><span class="s5">uploadNews</span><span class="s1">(</span><span class="s4">array </span><span class="s6">$articles</span><span class="s1">)
    { 
        </span><span class="s6">$url </span><span class="s1">= </span><span class="s7">'https://api.weixin.qq.com/cgi-bin/media/uploadnews'</span><span class="s1">;
        </span><span class="s6">$params </span><span class="s1">= [ 
            </span><span class="s7">'access_token' </span><span class="s1">=&gt; </span><span class="s6">$this</span><span class="s1">-&gt;</span><span class="s5">getAccessToken</span><span class="s1">()
        ]; 
        </span><span class="s6">$data </span><span class="s1">= [ 
            </span><span class="s7">'articles' </span><span class="s1">=&gt; </span><span class="s6">$articles</span><span class="s1">
        ]; 
        </span><span class="s4">return </span><span class="s6">$this</span><span class="s1">-&gt;</span><span class="s5">post</span><span class="s1">(</span><span class="s6">$url</span><span class="s1">, </span><span class="s6">$params</span><span class="s1">, </span><span class="s6">$data</span><span class="s1">);
    } 
 
    </span><span class="s2">/** 
     * 根据分组进行群发 
     * </span><span class="s3">@param </span><span class="s2">string|array $data 数据 
     * </span><span class="s3">@param </span><span class="s2">int $group_id 分组ID 
     * </span><span class="s3">@param </span><span class="s2">string $type 消息类型 
     * </span><span class="s3">@return </span><span class="s2">array|null 
     * </span><span class="s3">@throws </span><span class="s2">Exception 
     * </span><span class="s3">@link http://mp.weixin.qq.com/wiki/15/5380a4e6f02f2ffdc7981a8ed7a40753.html#.E6.A0.B9.E6.8D.AE.E5.88.86.E7.BB.84.E8.BF.9B.E8.A1.8C.E7.BE.A4.E5.8F.91.E3.80.90.E8.AE.A2.E9.98.85.E5.8F.B7.E4.B8.8E.E6.9C.8D.E5.8A.A1.E5.8F.B7.E8.AE.A4.E8.AF.81.E5.90.8E.E5.9D.87.E5.8F.AF.E7.94.A8.E3.80.91</span><span class="s2">
     */</span><span class="s1"> 
    </span><span class="s4">public function </span><span class="s5">sendMassToGroup</span><span class="s1">(</span><span class="s6">$data</span><span class="s1">, </span><span class="s6">$group_id</span><span class="s1">, </span><span class="s6">$type </span><span class="s1">= </span><span class="s7">'text'</span><span class="s1">)
    { 
        </span><span class="s6">$url </span><span class="s1">= </span><span class="s7">'https://api.weixin.qq.com/cgi-bin/message/mass/sendall'</span><span class="s1">;
        </span><span class="s6">$params </span><span class="s1">= [ 
            </span><span class="s7">'access_token' </span><span class="s1">=&gt; </span><span class="s6">$this</span><span class="s1">-&gt;</span><span class="s5">getAccessToken</span><span class="s1">()
        ]; 
        </span><span class="s6">$send </span><span class="s1">= [ 
            </span><span class="s7">'filter' </span><span class="s1">=&gt; [ 
                </span><span class="s7">'is_to_all' </span><span class="s1">=&gt; </span><span class="s5">false</span><span class="s1">,
                </span><span class="s7">'group_id' </span><span class="s1">=&gt; </span><span class="s6">$group_id</span><span class="s1">
            ], 
            </span><span class="s7">'msgtype' </span><span class="s1">=&gt; </span><span class="s6">$type</span><span class="s1">
        ]; 
 
        </span><span class="s4">switch </span><span class="s1">(</span><span class="s6">$type</span><span class="s1">) { 
            </span><span class="s4">case </span><span class="s7">'text'</span><span class="s1">: 
                </span><span class="s6">$send</span><span class="s1">[</span><span class="s7">'text'</span><span class="s1">] = [
                    </span><span class="s7">'content' </span><span class="s1">=&gt; </span><span class="s6">$data</span><span class="s1">
                ]; 
                </span><span class="s4">break</span><span class="s1">; 
            </span><span class="s4">case </span><span class="s7">'mpnews'</span><span class="s1">: 
            </span><span class="s4">case </span><span class="s7">'voice'</span><span class="s1">: 
            </span><span class="s4">case </span><span class="s7">'image'</span><span class="s1">: 
            </span><span class="s4">case </span><span class="s7">'mpvideo'</span><span class="s1">: 
                </span><span class="s6">$send</span><span class="s1">[</span><span class="s6">$type</span><span class="s1">] = [
                    </span><span class="s7">'media_id' </span><span class="s1">=&gt; </span><span class="s6">$data</span><span class="s1">
                ]; 
                </span><span class="s4">break</span><span class="s1">; 
        } 
        </span><span class="s4">return </span><span class="s6">$this</span><span class="s1">-&gt;</span><span class="s5">post</span><span class="s1">(</span><span class="s6">$url</span><span class="s1">, </span><span class="s6">$params</span><span class="s1">, </span><span class="s6">$send</span><span class="s1">);
    } 
 
    </span><span class="s2">/** 
     * 上传视频 
     * </span><span class="s3">@param </span><span class="s2">string $media_id 视频ID 
     * </span><span class="s3">@param </span><span class="s2">string $title 视频标题 
     * </span><span class="s3">@param </span><span class="s2">string $description 视频简介 
     * </span><span class="s3">@return </span><span class="s2">array|null 
     * </span><span class="s3">@throws </span><span class="s2">Exception 
     */</span><span class="s1"> 
    </span><span class="s4">public function </span><span class="s5">uploadVideo</span><span class="s1">(</span><span class="s6">$media_id</span><span class="s1">, </span><span class="s6">$title</span><span class="s1">, </span><span class="s6">$description</span><span class="s1">)
    { 
        </span><span class="s6">$url </span><span class="s1">= </span><span class="s7">'https://file.api.weixin.qq.com/cgi-bin/media/uploadvideo'</span><span class="s1">;
        </span><span class="s6">$params </span><span class="s1">= [ 
            </span><span class="s7">'access_token' </span><span class="s1">=&gt; </span><span class="s6">$this</span><span class="s1">-&gt;</span><span class="s5">getAccessToken</span><span class="s1">()
        ]; 
        </span><span class="s6">$data </span><span class="s1">= [ 
            </span><span class="s7">'media_id' </span><span class="s1">=&gt; </span><span class="s6">$media_id</span><span class="s1">,
            </span><span class="s7">'title' </span><span class="s1">=&gt; </span><span class="s6">$title</span><span class="s1">,
            </span><span class="s7">'description' </span><span class="s1">=&gt; </span><span class="s6">$description</span><span class="s1">
        ]; 
        </span><span class="s4">return </span><span class="s6">$this</span><span class="s1">-&gt;</span><span class="s5">post</span><span class="s1">(</span><span class="s6">$url</span><span class="s1">, </span><span class="s6">$params</span><span class="s1">, </span><span class="s6">$data</span><span class="s1">);
    } 
 
    </span><span class="s2">/** 
     * 根据Openid列表进行群发 
     * </span><span class="s3">@param </span><span class="s2">array $openids OPENID列表 
     * </span><span class="s3">@param </span><span class="s2">array|string $data 数据 
     * </span><span class="s3">@param </span><span class="s2">string $type 消息类型 
     * </span><span class="s3">@return </span><span class="s2">array|null 
     * </span><span class="s3">@throws </span><span class="s2">Exception 
     */</span><span class="s1"> 
    </span><span class="s4">public function </span><span class="s5">sendMassToOpenids</span><span class="s1">(</span><span class="s4">array </span><span class="s6">$openids</span><span class="s1">, </span><span class="s6">$data</span><span class="s1">, </span><span class="s6">$type </span><span class="s1">= </span><span class="s7">'text'</span><span class="s1">)
    { 
        </span><span class="s6">$url </span><span class="s1">= </span><span class="s7">'https://api.weixin.qq.com/cgi-bin/message/mass/send'</span><span class="s1">;
        </span><span class="s6">$params </span><span class="s1">= [ 
            </span><span class="s7">'access_token' </span><span class="s1">=&gt; </span><span class="s6">$this</span><span class="s1">-&gt;</span><span class="s5">getAccessToken</span><span class="s1">()
        ]; 
 
        </span><span class="s6">$send </span><span class="s1">= [ 
            </span><span class="s7">'touser' </span><span class="s1">=&gt; </span><span class="s6">$openids</span><span class="s1">,
            </span><span class="s7">'msgtype' </span><span class="s1">=&gt; </span><span class="s6">$type</span><span class="s1">
        ]; 
 
        </span><span class="s4">switch </span><span class="s1">(</span><span class="s6">$type</span><span class="s1">) { 
            </span><span class="s4">case </span><span class="s7">'text'</span><span class="s1">: 
                </span><span class="s6">$send</span><span class="s1">[</span><span class="s7">'text'</span><span class="s1">] = [
                    </span><span class="s7">'content' </span><span class="s1">=&gt; </span><span class="s6">$data</span><span class="s1">
                ]; 
                </span><span class="s4">break</span><span class="s1">; 
            </span><span class="s4">case </span><span class="s7">'mpnews'</span><span class="s1">: 
            </span><span class="s4">case </span><span class="s7">'voice'</span><span class="s1">: 
            </span><span class="s4">case </span><span class="s7">'image'</span><span class="s1">: 
            </span><span class="s4">case </span><span class="s7">'mpvideo'</span><span class="s1">: 
                </span><span class="s6">$send</span><span class="s1">[</span><span class="s6">$type</span><span class="s1">] = [
                    </span><span class="s7">'media_id' </span><span class="s1">=&gt; </span><span class="s6">$data</span><span class="s1">
                ]; 
                </span><span class="s4">break</span><span class="s1">; 
        } 
        </span><span class="s4">return </span><span class="s6">$this</span><span class="s1">-&gt;</span><span class="s5">post</span><span class="s1">(</span><span class="s6">$url</span><span class="s1">, </span><span class="s6">$params</span><span class="s1">, </span><span class="s6">$send</span><span class="s1">);
    } 
 
    </span><span class="s2">/** 
     * 删除群发 
     * </span><span class="s3">@param </span><span class="s2">int $msg_id 消息ID 
     * </span><span class="s3">@return </span><span class="s2">array|null 
     * </span><span class="s3">@throws </span><span class="s2">Exception 
     */</span><span class="s1"> 
    </span><span class="s4">public function </span><span class="s5">deleteMass</span><span class="s1">(</span><span class="s6">$msg_id</span><span class="s1">)
    { 
        </span><span class="s6">$url </span><span class="s1">= </span><span class="s7">'https://api.weixin.qq.com/cgi-bin/message/mass/delete'</span><span class="s1">;
        </span><span class="s6">$params </span><span class="s1">= [ 
            </span><span class="s7">'access_token' </span><span class="s1">=&gt; </span><span class="s6">$this</span><span class="s1">-&gt;</span><span class="s5">getAccessToken</span><span class="s1">()
        ]; 
        </span><span class="s6">$data </span><span class="s1">= [ 
            </span><span class="s7">'msg_id' </span><span class="s1">=&gt; </span><span class="s6">$msg_id</span><span class="s1">
        ]; 
        </span><span class="s4">return </span><span class="s6">$this</span><span class="s1">-&gt;</span><span class="s5">post</span><span class="s1">(</span><span class="s6">$url</span><span class="s1">, </span><span class="s6">$params</span><span class="s1">, </span><span class="s6">$data</span><span class="s1">);
    } 
 
    </span><span class="s2">/** 
     * 预览群发消息 
     * </span><span class="s3">@param </span><span class="s2">string $openid 预览者ID 
     * </span><span class="s3">@param </span><span class="s2">array|string $data 数据 
     * </span><span class="s3">@param </span><span class="s2">string $type 消息类型 
     * </span><span class="s3">@return </span><span class="s2">array|null 
     * </span><span class="s3">@throws </span><span class="s2">Exception 
     */</span><span class="s1"> 
    </span><span class="s4">public function </span><span class="s5">previewMass</span><span class="s1">(</span><span class="s6">$openid</span><span class="s1">, </span><span class="s6">$data</span><span class="s1">, </span><span class="s6">$type </span><span class="s1">= </span><span class="s7">'text'</span><span class="s1">)
    { 
        </span><span class="s6">$url </span><span class="s1">= </span><span class="s7">'https://api.weixin.qq.com/cgi-bin/message/mass/preview'</span><span class="s1">;
        </span><span class="s6">$params </span><span class="s1">= [ 
            </span><span class="s7">'access_token' </span><span class="s1">=&gt; </span><span class="s6">$this</span><span class="s1">-&gt;</span><span class="s5">getAccessToken</span><span class="s1">()
        ]; 
 
        </span><span class="s6">$send </span><span class="s1">= [ 
            </span><span class="s7">'touser' </span><span class="s1">=&gt; </span><span class="s6">$openid</span><span class="s1">,
            </span><span class="s7">'msgtype' </span><span class="s1">=&gt; </span><span class="s6">$type</span><span class="s1">
        ]; 
 
        </span><span class="s4">switch </span><span class="s1">(</span><span class="s6">$type</span><span class="s1">) { 
            </span><span class="s4">case </span><span class="s7">'text'</span><span class="s1">: 
                </span><span class="s6">$send</span><span class="s1">[</span><span class="s7">'text'</span><span class="s1">] = [
                    </span><span class="s7">'content' </span><span class="s1">=&gt; </span><span class="s6">$data</span><span class="s1">
                ]; 
                </span><span class="s4">break</span><span class="s1">; 
            </span><span class="s4">case </span><span class="s7">'mpnews'</span><span class="s1">: 
            </span><span class="s4">case </span><span class="s7">'voice'</span><span class="s1">: 
            </span><span class="s4">case </span><span class="s7">'image'</span><span class="s1">: 
            </span><span class="s4">case </span><span class="s7">'mpvideo'</span><span class="s1">: 
                </span><span class="s6">$send</span><span class="s1">[</span><span class="s6">$type</span><span class="s1">] = [
                    </span><span class="s7">'media_id' </span><span class="s1">=&gt; </span><span class="s6">$data</span><span class="s1">
                ]; 
                </span><span class="s4">break</span><span class="s1">; 
        } 
        </span><span class="s4">return </span><span class="s6">$this</span><span class="s1">-&gt;</span><span class="s5">post</span><span class="s1">(</span><span class="s6">$url</span><span class="s1">, </span><span class="s6">$params</span><span class="s1">, </span><span class="s6">$send</span><span class="s1">);
    } 
 
    </span><span class="s2">/** 
     * 获取群发消息状态 
     * </span><span class="s3">@param </span><span class="s2">int $msg_id 消息ID 
     * </span><span class="s3">@return </span><span class="s2">array|null 
     * </span><span class="s3">@throws </span><span class="s2">Exception 
     */</span><span class="s1"> 
    </span><span class="s4">public function </span><span class="s5">getMassStatus</span><span class="s1">(</span><span class="s6">$msg_id</span><span class="s1">)
    { 
        </span><span class="s6">$url </span><span class="s1">= </span><span class="s7">'https://api.weixin.qq.com/cgi-bin/message/mass/get'</span><span class="s1">;
        </span><span class="s6">$params </span><span class="s1">= [ 
            </span><span class="s7">'access_token' </span><span class="s1">=&gt; </span><span class="s6">$this</span><span class="s1">-&gt;</span><span class="s5">getAccessToken</span><span class="s1">()
        ]; 
        </span><span class="s6">$data </span><span class="s1">= [ 
            </span><span class="s7">'msg_id' </span><span class="s1">=&gt; </span><span class="s6">$msg_id</span><span class="s1">
        ]; 
        </span><span class="s4">return </span><span class="s6">$this</span><span class="s1">-&gt;</span><span class="s5">post</span><span class="s1">(</span><span class="s6">$url</span><span class="s1">, </span><span class="s6">$params</span><span class="s1">, </span><span class="s6">$data</span><span class="s1">);
    } 
 
    </span><span class="s2">/** 
     * 设置模板消息所属行业 
     * </span><span class="s3">@param </span><span class="s2">int $industry_id1 行业一ID 
     * </span><span class="s3">@param </span><span class="s2">int $industry_id2 行业二ID 
     * </span><span class="s3">@return </span><span class="s2">array|null 
     * </span><span class="s3">@throws </span><span class="s2">Exception 
     * </span><span class="s3">@link http://mp.weixin.qq.com/wiki/17/304c1885ea66dbedf7dc170d84999a9d.html#.E8.AE.BE.E7.BD.AE.E6.89.80.E5.B1.9E.E8.A1.8C.E4.B8.9A</span><span class="s2">
     */</span><span class="s1"> 
    </span><span class="s4">public function </span><span class="s5">setTemplateIndustry</span><span class="s1">(</span><span class="s6">$industry_id1</span><span class="s1">, </span><span class="s6">$industry_id2</span><span class="s1">)
    { 
        </span><span class="s6">$url </span><span class="s1">= </span><span class="s7">'https://api.weixin.qq.com/cgi-bin/message/mass/delete'</span><span class="s1">;
        </span><span class="s6">$params </span><span class="s1">= [ 
            </span><span class="s7">'access_token' </span><span class="s1">=&gt; </span><span class="s6">$this</span><span class="s1">-&gt;</span><span class="s5">getAccessToken</span><span class="s1">()
        ]; 
        </span><span class="s6">$data </span><span class="s1">= [ 
            </span><span class="s7">'industry_id1' </span><span class="s1">=&gt; </span><span class="s6">$industry_id1</span><span class="s1">,
            </span><span class="s7">'industry_id2' </span><span class="s1">=&gt; </span><span class="s6">$industry_id2</span><span class="s1">
        ]; 
        </span><span class="s4">return </span><span class="s6">$this</span><span class="s1">-&gt;</span><span class="s5">post</span><span class="s1">(</span><span class="s6">$url</span><span class="s1">, </span><span class="s6">$params</span><span class="s1">, </span><span class="s6">$data</span><span class="s1">);
    } 
 
    </span><span class="s2">/** 
     * 获得模板ID 
     * </span><span class="s3">@param </span><span class="s2">string $template_id_short 模板库中模板的编号，有“TM**”和“OPENTMTM**”等形式 
     * </span><span class="s3">@return </span><span class="s2">array|null 
     * </span><span class="s3">@throws </span><span class="s2">Exception 
     */</span><span class="s1"> 
    </span><span class="s4">public function </span><span class="s5">getTemplateId</span><span class="s1">(</span><span class="s6">$template_id_short</span><span class="s1">)
    { 
        </span><span class="s6">$url </span><span class="s1">= </span><span class="s7">'https://api.weixin.qq.com/cgi-bin/template/api_add_template'</span><span class="s1">;
        </span><span class="s6">$params </span><span class="s1">= [ 
            </span><span class="s7">'access_token' </span><span class="s1">=&gt; </span><span class="s6">$this</span><span class="s1">-&gt;</span><span class="s5">getAccessToken</span><span class="s1">()
        ]; 
        </span><span class="s6">$data </span><span class="s1">= [ 
            </span><span class="s7">'template_id_short' </span><span class="s1">=&gt; </span><span class="s6">$template_id_short</span><span class="s1">
        ]; 
        </span><span class="s4">return </span><span class="s6">$this</span><span class="s1">-&gt;</span><span class="s5">post</span><span class="s1">(</span><span class="s6">$url</span><span class="s1">, </span><span class="s6">$params</span><span class="s1">, </span><span class="s6">$data</span><span class="s1">);
    } 
 
    </span><span class="s2">/** 
     * 发送模板消息 
     * </span><span class="s3">@param </span><span class="s2">string $openid 用户ID 
     * </span><span class="s3">@param </span><span class="s2">string $template_id 模板ID 
     * </span><span class="s3">@param </span><span class="s2">string $link 点击模板消息跳转链接 
     * </span><span class="s3">@param </span><span class="s2">array $data 模板数据 
     * </span><span class="s3">@param </span><span class="s2">string $topcolor 
     * </span><span class="s3">@return </span><span class="s2">array|null 
     * </span><span class="s3">@throws </span><span class="s2">Exception 
     * </span><span class="s3">@link http://mp.weixin.qq.com/wiki/17/304c1885ea66dbedf7dc170d84999a9d.html#.E5.8F.91.E9.80.81.E6.A8.A1.E6.9D.BF.E6.B6.88.E6.81.AF</span><span class="s2">
     */</span><span class="s1"> 
    </span><span class="s4">public function </span><span class="s5">sendTemplate</span><span class="s1">(</span><span class="s6">$openid</span><span class="s1">, </span><span class="s6">$template_id</span><span class="s1">, </span><span class="s6">$link</span><span class="s1">, </span><span class="s6">$data</span><span class="s1">, </span><span class="s6">$topcolor </span><span class="s1">= </span><span class="s7">'#FF0000'</span><span class="s1">)
    { 
        </span><span class="s6">$url </span><span class="s1">= </span><span class="s7">'https://api.weixin.qq.com/cgi-bin/message/template/send'</span><span class="s1">;
        </span><span class="s6">$params </span><span class="s1">= [ 
            </span><span class="s7">'access_token' </span><span class="s1">=&gt; </span><span class="s6">$this</span><span class="s1">-&gt;</span><span class="s5">getAccessToken</span><span class="s1">()
        ]; 
        </span><span class="s6">$data </span><span class="s1">= [ 
            </span><span class="s7">'touser' </span><span class="s1">=&gt; </span><span class="s6">$openid</span><span class="s1">,
            </span><span class="s7">'template_id' </span><span class="s1">=&gt; </span><span class="s6">$template_id</span><span class="s1">,
            </span><span class="s7">'url' </span><span class="s1">=&gt; </span><span class="s6">$link</span><span class="s1">,
            </span><span class="s7">'topcolor' </span><span class="s1">=&gt; </span><span class="s6">$topcolor</span><span class="s1">,
            </span><span class="s7">'data' </span><span class="s1">=&gt; </span><span class="s6">$data</span><span class="s1">
        ]; 
        </span><span class="s4">return </span><span class="s6">$this</span><span class="s1">-&gt;</span><span class="s5">post</span><span class="s1">(</span><span class="s6">$url</span><span class="s1">, </span><span class="s6">$params</span><span class="s1">, </span><span class="s6">$data</span><span class="s1">);
    } 
}</span></pre>
</body>
</html>